<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>beepkeep</title>
    <style>
        @font-face {
            font-family: 'Innovator Grotesk';
            src: url('./assets/InnovatorGroteskVF-VF.woff2') format('woff2');
            font-weight: 100 900;
            font-style: normal;
            font-display: swap;
        }

        :root {
            /* Deep matte blacks */
            --bg-void: #050505;
            --bg-deep: #0a0a0a;
            --bg-panel: #111111;
            --bg-surface: #161616;
            --bg-raised: #1a1a1a;
            --bg-elevated: #1f1f1f;
            
            /* Accent - Orange */
            --accent: #ff6b1a;
            --accent-dim: #cc5514;
            --accent-glow: rgba(255, 107, 26, 0.5);
            --accent-subtle: rgba(255, 107, 26, 0.15);
            
            /* Secondary accents */
            --positive: #00ff88;
            --positive-glow: rgba(0, 255, 136, 0.4);
            --negative: #ff3b3b;
            --negative-glow: rgba(255, 59, 59, 0.4);
            
            /* Text */
            --text-bright: #ffffff;
            --text-primary: rgba(255, 255, 255, 0.9);
            --text-secondary: rgba(255, 255, 255, 0.55);
            --text-muted: rgba(255, 255, 255, 0.3);
            --text-ghost: rgba(255, 255, 255, 0.15);
            
            /* Borders */
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-dim: rgba(255, 255, 255, 0.1);
            --border-accent: rgba(255, 107, 26, 0.3);
            
            /* Sizing */
            --knob-size: 64px;
            --knob-size-sm: 48px;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            font-family: 'Innovator Grotesk', -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            background: var(--bg-void);
            color: var(--text-primary);
            line-height: 1.4;
            min-height: 100vh;
            font-weight: 300;
            letter-spacing: 0.01em;
            overflow-x: hidden;
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            background: var(--bg-deep);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-mark {
            width: 40px;
            height: 40px;
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .logo-mark::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            filter: blur(8px);
            opacity: 0.8;
        }

        .logo-mark::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .logo-mark .sonar-ring {
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            filter: blur(1px);
        }

        .logo-mark:hover .sonar-ring {
            animation: sonarPulse 0.6s ease-out forwards;
        }

        @keyframes sonarPulse {
            0% {
                width: 10px;
                height: 10px;
                opacity: 0.8;
                filter: blur(1px);
            }
            100% {
                width: 70px;
                height: 70px;
                opacity: 0;
                filter: blur(3px);
            }
        }

        .logo-text {
            font-size: 20px;
            font-weight: 400;
            letter-spacing: 0.08em;
            text-transform: lowercase;
        }

        .logo-text span {
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* LED Indicator */
        .led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-ghost);
            /* Slow capacitor discharge fade out, fast turn on */
            transition: background 1.2s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .led.active {
            background: var(--positive);
            box-shadow: 0 0 8px var(--positive-glow), 0 0 16px var(--positive-glow);
            /* Fast turn on */
            transition: background 0.1s ease-out,
                        box-shadow 0.15s ease-out;
        }

        .led.warning {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent-glow);
        }

        /* Audio Init Button */
        .audio-init-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: 20px;
            font-family: inherit;
            font-size: 11px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .audio-init-btn:hover {
            border-color: var(--border-accent);
            color: var(--text-secondary);
        }

        .audio-init-btn.active {
            border-color: rgba(0, 255, 136, 0.3);
            color: var(--text-secondary);
            cursor: default;
        }

        .audio-init-btn.active:hover {
            border-color: rgba(0, 255, 136, 0.3);
        }

        /* Status pill */
        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-surface);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        /* ============================================
           NAVIGATION
           ============================================ */
        .nav {
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 16px 32px;
            background: var(--bg-deep);
            border-bottom: 1px solid var(--border-subtle);
        }

        .nav-item {
            padding: 10px 24px;
            font-size: 12px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-item:hover {
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--accent);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -17px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 2px;
            background: var(--accent);
            border-radius: 1px;
            box-shadow: 0 0 8px var(--accent-glow);
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main {
            padding: 32px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* ============================================
           PANEL CARDS
           ============================================ */
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .card-title {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .card-body {
            padding: 24px;
        }

        /* ============================================
           ROTARY KNOB
           ============================================ */
        .knob-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .knob {
            width: var(--knob-size);
            height: var(--knob-size);
            position: relative;
            cursor: grab;
            user-select: none;
        }

        .knob:active { cursor: grabbing; }

        .knob-track {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-dim);
        }

        .knob-arc {
            position: absolute;
            inset: -4px;
            transform: rotate(135deg);
            overflow: visible;
        }

        .knob-arc circle {
            fill: none;
            stroke: var(--accent);
            stroke-width: 6;
            stroke-linecap: butt;
            opacity: var(--arc-intensity, 1);
            filter: drop-shadow(0 0 calc(var(--arc-intensity, 0.4) * 6px) var(--accent-glow));
        }

        .knob-cap {
            position: absolute;
            inset: 12px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--bg-elevated) 0%, var(--bg-surface) 100%);
            border: 1px solid var(--border-dim);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .knob-indicator {
            position: absolute;
            width: 2px;
            height: 10px;
            background: var(--accent);
            top: 6px;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(calc(var(--rotation, 0) * 1deg));
            border-radius: 1px;
            box-shadow: 0 0 6px var(--accent-glow);
        }

        .knob-value {
            font-size: 11px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            color: var(--text-bright);
        }

        .knob-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        /* Small knob variant */
        .knob.sm {
            width: var(--knob-size-sm);
            height: var(--knob-size-sm);
        }

        .knob.sm .knob-cap { inset: 8px; }
        .knob.sm .knob-indicator { height: 8px; top: 4px; }

        /* ============================================
           FX RACK (Filters)
           ============================================ */
        .fx-rack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .fx-pedal {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: all 0.2s ease;
        }

        .fx-pedal.active {
            border-color: var(--border-accent);
            box-shadow: 0 0 24px rgba(255, 107, 26, 0.08);
        }

        .fx-pedal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .fx-pedal-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fx-pedal-name span {
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        /* Power switch */
        .power-switch {
            width: 40px;
            height: 22px;
            background: var(--bg-elevated);
            border-radius: 11px;
            border: 1px solid var(--border-dim);
            cursor: pointer;
            position: relative;
            transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
        }

        .power-switch::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--bg-raised);
            border-radius: 50%;
            top: 50%;
            left: 3px;
            transform: translateY(-50%) scale(1);
            transition: left 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        background 0.2s ease, 
                        border-color 0.2s ease, 
                        box-shadow 0.3s ease,
                        transform 0.15s ease;
            border: 1px solid var(--border-dim);
        }

        .power-switch:active::after {
            transform: translateY(-50%) scale(0.9);
        }

        .power-switch.on {
            background: var(--accent-subtle);
            border-color: var(--border-accent);
            box-shadow: 0 0 12px rgba(255, 107, 26, 0.15);
        }

        .power-switch.on::after {
            left: 21px;
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .fx-pedal-knobs {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 16px;
        }

        /* ============================================
           SOUND LANES (Trades/Liquidations)
           ============================================ */
        .sound-lanes {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sound-lane {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .lane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-subtle);
        }

        .lane-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lane-badge {
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
        }

        /* Level badges: calm → intense progression */
        .lane-badge.level-0 { background: rgba(140, 150, 165, 0.15); color: rgba(160, 170, 185, 0.8); }
        .lane-badge.level-1 { background: rgba(0, 200, 220, 0.15); color: #00c8dc; }
        .lane-badge.level-2 { background: rgba(255, 200, 0, 0.15); color: #ffc800; }
        .lane-badge.level-3 { background: var(--accent-subtle); color: var(--accent); }

        .lane-amount {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        .lane-actions {
            display: flex;
            gap: 8px;
        }

        .lane-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border-subtle);
        }

        .lane-side {
            padding: 16px 20px;
            background: var(--bg-surface);
        }

        .lane-side-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .lane-side-label.buy { color: var(--positive); }
        .lane-side-label.sell { color: var(--negative); }

        /* Sound blocks visualization */
        .sound-blocks {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .sound-block {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-panel);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-sm);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .sound-block:hover {
            border-color: var(--accent);
            background: var(--accent-subtle);
        }

        .sound-block .note {
            font-weight: 600;
            color: var(--accent);
        }

        .sound-block .timing {
            color: var(--text-muted);
        }

        .sound-block.add-block {
            border-style: dashed;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 400;
            justify-content: center;
            min-width: 32px;
            padding: 6px 8px;
        }

        .sound-block.add-block:hover {
            color: var(--accent);
        }

        .sound-block-remove {
            margin-left: 2px;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: var(--text-ghost);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.15s ease;
            opacity: 0;
        }

        .sound-block:hover .sound-block-remove {
            opacity: 1;
        }

        .sound-block-remove:hover {
            color: var(--text-secondary);
            background: var(--bg-elevated);
        }

        /* Script note editor (for trades/liqs) */
        .script-note-editor {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .script-note-editor.open { display: flex; }
        .script-note-editor-content {
            background: var(--bg-panel);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-xl);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .script-note-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .script-note-editor-title {
            font-size: 16px;
            font-weight: 500;
        }
        .script-note-editor-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
        }
        .script-note-editor-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .script-note-current {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 8px;
        }
        .script-note-info {
            text-align: left;
        }
        .script-note-current .note-display {
            font-size: 32px;
            font-weight: 600;
            color: var(--accent);
        }
        .script-note-current .freq-display {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .script-delay-knob-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .script-delay-knob-wrap .knob-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }
        .script-delay-knob-wrap .knob-value {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .script-key-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 16px;
        }
        .script-key-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .script-key-row.sharps {
            padding: 0 calc(100% / 14);
        }
        .script-key-btn {
            padding: 6px 4px;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .script-key-btn.sharp {
            background: var(--bg-elevated);
            font-size: 11px;
        }
        .script-key-btn.spacer {
            visibility: hidden;
            pointer-events: none;
        }
        .script-key-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-dim);
            color: var(--text-primary);
        }
        .script-key-btn.sharp:hover {
            background: var(--bg-raised);
        }
        .script-key-btn.selected {
            background: var(--accent-subtle);
            border-color: var(--accent);
            color: var(--accent);
        }
        .script-octave-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        .script-octave-btn {
            width: 44px;
            height: 36px;
            padding: 0;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .script-octave-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .script-octave-btn.selected {
            background: var(--accent-subtle);
            border-color: var(--accent);
            color: var(--accent);
        }
        .script-editor-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .script-osc-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }
        .script-osc-btn {
            padding: 0 12px;
            height: 36px;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .script-osc-btn svg {
            width: 28px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }
        .script-osc-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }
        .script-osc-btn.selected {
            background: var(--accent-subtle);
            border-color: var(--accent);
            color: var(--accent);
        }
        .script-editor-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* ============================================
           CHORD BUILDER (Position Events)
           ============================================ */
        .chord-builder {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .chord-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .chord-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-subtle);
        }

        .chord-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .chord-card-title svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .chord-card-title.long svg { fill: var(--positive); }
        .chord-card-title.short svg { fill: var(--negative); }
        .chord-card-title.profit svg { fill: var(--positive); }
        .chord-card-title.loss svg { fill: var(--negative); }

        .chord-card-body {
            padding: 16px 20px;
            background: var(--bg-surface);
        }

        .chord-card-body .sound-blocks {
            margin-bottom: 0;
        }

        /* Note pills */
        .note-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .note-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-panel);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-md);
            cursor: grab;
            transition: all 0.15s ease;
        }

        .note-pill:hover {
            border-color: var(--border-accent);
        }

        .note-pill.dragging {
            opacity: 0.5;
        }

        .note-pill-key {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            min-width: 28px;
        }

        .note-pill-osc {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            padding: 2px 6px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
        }

        .note-pill-timing {
            font-size: 10px;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        .note-pill-remove {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.15s ease;
        }

        .note-pill-remove:hover {
            background: var(--negative);
            color: var(--text-bright);
        }

        .add-note-btn {
            padding: 8px 16px;
            font-size: 11px;
            background: var(--bg-panel);
            border: 1px dashed var(--border-dim);
            color: var(--text-muted);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .add-note-btn:hover {
            border-color: var(--accent);
            border-style: solid;
            color: var(--accent);
        }

        /* Note editor modal */
        .note-editor {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .note-editor.open { display: flex; }

        .note-editor-content {
            background: var(--bg-panel);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-xl);
            padding: 24px;
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .note-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .note-editor-title {
            font-size: 16px;
            font-weight: 500;
        }

        .note-editor-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .note-editor-close:hover {
            border-color: var(--negative);
            color: var(--negative);
        }

        /* Key selector */
        .key-selector {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 24px;
        }

        .key-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .key-row.sharps {
            padding: 0 calc(100% / 14);
        }

        .key-btn {
            padding: 10px 4px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .key-btn.sharp {
            background: var(--bg-elevated);
            font-size: 11px;
            padding: 8px 2px;
        }

        .key-btn.spacer {
            visibility: hidden;
            pointer-events: none;
        }

        .key-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .key-btn.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-void);
        }

        .octave-selector {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 24px;
        }

        .octave-btn {
            padding: 8px 16px;
            font-size: 11px;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .octave-btn:hover { border-color: var(--border-accent); }
        .octave-btn.selected { background: var(--accent-subtle); border-color: var(--accent); color: var(--accent); }

        /* Oscillator selector (shared by both editors) */
        .osc-selector {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 24px;
        }
        .osc-btn {
            padding: 8px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .osc-btn svg {
            width: 28px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }
        .osc-btn:hover { border-color: var(--border-accent); color: var(--text-secondary); }
        .osc-btn.selected { background: var(--accent-subtle); border-color: var(--accent); color: var(--accent); }

        /* Editor knobs */
        .editor-knobs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 24px;
        }

        .editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ============================================
           PATCH BAY (Export)
           ============================================ */
        .patch-bay {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .patch-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .patch-preview {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 20px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-secondary);
            max-height: 600px;
            overflow: auto;
            white-space: pre-wrap;
        }

        .patch-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .patch-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .validation-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
        }

        .validation-status.valid .led { background: var(--positive); box-shadow: 0 0 8px var(--positive-glow); }
        .validation-status.invalid .led { background: var(--negative); box-shadow: 0 0 8px var(--negative-glow); }

        .validation-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .patch-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            padding: 10px 20px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-default {
            background: var(--bg-surface);
            color: var(--text-secondary);
        }

        .btn-default:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-accent);
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-void);
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-dim);
            box-shadow: 0 0 16px var(--accent-glow);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border-color: transparent;
        }

        .btn-ghost:hover {
            color: var(--text-secondary);
            background: var(--bg-surface);
        }

        .btn-danger {
            background: transparent;
            color: var(--negative);
            border-color: var(--negative);
        }

        .btn-danger:hover {
            background: rgba(255, 59, 59, 0.15);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 10px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            padding-left: 2px; /* Optical centering for play triangle */
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            font-size: 10px;
            transition: background 0.15s ease, border-color 0.15s ease;
        }

        .btn-icon:hover {
            background: var(--bg-raised);
            border-color: var(--border-dim);
        }

        .btn-icon:active {
            background: var(--bg-surface);
        }

        /* Play button - green/buy */
        .btn-play {
            border-color: rgba(0, 255, 136, 0.4);
            color: var(--positive);
            background: rgba(0, 255, 136, 0.08);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.05em;
        }
        .btn-play:hover {
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.6);
        }

        /* Sell button - red */
        .btn-sell {
            border-color: rgba(255, 59, 59, 0.4);
            color: var(--negative);
            background: rgba(255, 59, 59, 0.08);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.05em;
        }
        .btn-sell:hover {
            background: rgba(255, 59, 59, 0.15);
            border-color: rgba(255, 59, 59, 0.6);
        }

        /* ============================================
           RATIO SLIDER
           ============================================ */
        .ratio-control {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 16px 24px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .ratio-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-dim);
            color: var(--text-muted);
            font-size: 9px;
            font-style: normal;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            position: relative;
        }

        .info-icon:hover {
            color: var(--text-secondary);
            border-color: var(--border-accent);
        }

        .info-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-sm);
            padding: 10px 10px;
            font-size: 11px;
            font-style: normal;
            font-weight: 400;
            letter-spacing: 0;
            text-transform: none;
            color: var(--text-secondary);
            white-space: normal;
            width: 200px;
            line-height: 1.5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 100;
        }

        .info-icon:hover::after {
            opacity: 1;
        }

        .ratio-track {
            flex: 1;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            position: relative;
        }

        .ratio-fill {
            position: absolute;
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .ratio-thumb {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .ratio-thumb:active { cursor: grabbing; }

        .ratio-value {
            font-size: 20px;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            color: var(--text-bright);
            min-width: 60px;
            text-align: right;
        }

        /* Scale Selector */
        .scale-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .scale-selector.positions-scale {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 12px 16px;
            margin-bottom: 24px;
        }

        .scale-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .scale-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .scale-btn {
            min-width: 72px;
            padding: 6px 10px;
            font-size: 10px;
            font-weight: 500;
            background: var(--bg-elevated);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
        }

        .scale-btn:hover {
            background: var(--bg-raised);
            border-color: var(--border-dim);
            color: var(--text-primary);
        }

        .scale-btn.selected {
            background: var(--accent-subtle);
            border-color: var(--accent);
            color: var(--accent);
        }

        .scale-btn.astley {
            font-style: italic;
        }

        .scale-btn.astley.selected {
            animation: rick-roll 0.5s ease;
        }

        @keyframes rick-roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        /* ============================================
           TOAST
           ============================================ */
        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 14px 20px;
            background: var(--bg-panel);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ============================================
           SCROLLBAR
           ============================================ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-dim); }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 1200px) {
            .chord-builder { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .header { padding: 16px; }
            .nav { padding: 12px 16px; overflow-x: auto; }
            .main { padding: 16px; }
            .fx-rack { grid-template-columns: 1fr; }
            .patch-toolbar { flex-direction: column; align-items: stretch; }
            .patch-actions { flex-direction: column; }
            .patch-actions .btn { width: 100%; }
            .validation-status { justify-content: center; }
            .scale-buttons { flex-wrap: wrap; justify-content: center; }
            .level-row { flex-direction: column; gap: 12px; }
            .level-row .level-label { min-width: auto; }
        }

        @media (max-width: 480px) {
            .header { padding: 12px; gap: 12px; }
            .logo-text { font-size: 18px; }
            .nav { gap: 4px; }
            .nav-item { padding: 10px 12px; font-size: 11px; }
            .main { padding: 12px; }
            .ratio-control { flex-wrap: wrap; gap: 8px; }
            .ratio-track { flex: 1 1 100%; order: 1; }
            .chord-card { padding: 16px; }
            .patch-preview { font-size: 10px; max-height: 400px; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <a href="https://github.com/appdefi" target="_blank" class="logo-mark"><span class="sonar-ring"></span></a>
            <div class="logo-text">beep<span>keep</span></div>
        </div>
        <div class="header-controls">
            <button class="audio-init-btn" id="initAudioBtn">
                <div class="led" id="audioLed"></div>
                <span id="audioStatus">Initialize Audio</span>
            </button>
        </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="nav">
        <button class="nav-item active" data-panel="trades">Trades</button>
        <button class="nav-item" data-panel="liquidations">Liquidations</button>
        <button class="nav-item" data-panel="positions">Positions</button>
        <button class="nav-item" data-panel="filters">FX Rack</button>
        <button class="nav-item" data-panel="export">Patch Bay</button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- TRADES PANEL -->
        <section id="panel-trades" class="panel active">
            <div class="ratio-control">
                <span class="ratio-label">Ratio <span class="info-icon" data-tooltip="Scales sound intensity to simulate different trade sizes">i</span></span>
                <div class="ratio-track" id="tradeRatioTrack">
                    <div class="ratio-fill" style="width: 31.03%;"></div>
                    <div class="ratio-thumb" style="left: 31.03%;"></div>
                </div>
                <span class="ratio-value" id="tradeRatioValue">1.00</span>
                <button class="btn btn-play btn-sm" onclick="playAllTrades('buy')">▶ Buy</button>
                <button class="btn btn-sell btn-sm" onclick="playAllTrades('sell')">▶ Sell</button>
            </div>
            <div class="scale-selector" id="tradeScaleSelector"></div>
            <div class="sound-lanes" id="tradeLanes"></div>
        </section>

        <!-- LIQUIDATIONS PANEL -->
        <section id="panel-liquidations" class="panel">
            <div class="ratio-control">
                <span class="ratio-label">Ratio <span class="info-icon" data-tooltip="Scales sound intensity to simulate different liquidation sizes">i</span></span>
                <div class="ratio-track" id="liqRatioTrack">
                    <div class="ratio-fill" style="width: 31.03%;"></div>
                    <div class="ratio-thumb" style="left: 31.03%;"></div>
                </div>
                <span class="ratio-value" id="liqRatioValue">1.00</span>
                <button class="btn btn-play btn-sm" onclick="playAllLiqs('buy')">▶ Buy</button>
                <button class="btn btn-sell btn-sm" onclick="playAllLiqs('sell')">▶ Sell</button>
            </div>
            <div class="scale-selector" id="liqScaleSelector"></div>
            <div class="sound-lanes" id="liqLanes"></div>
        </section>

        <!-- POSITIONS PANEL -->
        <section id="panel-positions" class="panel">
            <div class="scale-selector positions-scale" id="positionsScaleSelector"></div>
            <div class="chord-builder" id="chordBuilder"></div>
        </section>

        <!-- FX RACK PANEL -->
        <section id="panel-filters" class="panel">
            <div class="fx-rack" id="fxRack"></div>
        </section>

        <!-- PATCH BAY PANEL -->
        <section id="panel-export" class="panel">
            <div class="patch-bay">
                <div class="patch-toolbar">
                    <input type="file" id="patchFileInput" accept=".ts,.json" style="display: none;" onchange="loadFromFile(event)">
                    <div class="patch-actions">
                        <button class="btn btn-primary" onclick="copyPatch()">📋 Copy Patch</button>
                        <button class="btn btn-default" onclick="downloadPatch()">💾 Download .ts</button>
                        <button class="btn btn-default" onclick="document.getElementById('patchFileInput').click()">📁 Load File</button>
                        <button class="btn btn-default" onclick="saveToBrowser()">💾 Save Local</button>
                        <button class="btn btn-ghost" onclick="loadFromBrowser()">📂 Load Saved</button>
                    </div>
                    <div class="validation-status" id="validationStatus">
                        <div class="led"></div>
                        <span class="validation-label">Schema Valid</span>
                    </div>
                </div>
                <div class="patch-preview" id="patchPreview"></div>
            </div>
        </section>
    </main>

    <!-- NOTE EDITOR MODAL -->
    <div class="note-editor" id="noteEditor">
        <div class="note-editor-content">
            <div class="note-editor-header">
                <span class="note-editor-title">Edit Note</span>
                <button class="note-editor-close" onclick="closeNoteEditor()">✕</button>
            </div>
            <div class="key-selector" id="keySelector"></div>
            <div class="octave-selector" id="octaveSelector"></div>
            <div class="osc-selector" id="oscSelector"></div>
            <div class="editor-knobs" id="editorKnobs"></div>
            <div class="editor-actions">
                <button class="btn btn-danger" id="noteDeleteBtn" onclick="deletePositionNote()">Delete</button>
                <div style="flex: 1;"></div>
                <button class="btn btn-ghost" onclick="closeNoteEditor()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNoteEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT NOTE EDITOR MODAL (for trades/liqs) -->
    <div class="script-note-editor" id="scriptNoteEditor">
        <div class="script-note-editor-content">
            <div class="script-note-editor-header">
                <span class="script-note-editor-title">Edit Note</span>
                <button class="script-note-editor-close" onclick="closeScriptNoteEditor()">✕</button>
            </div>
            <div class="script-note-current">
                <div class="script-note-info">
                    <div class="note-display" id="scriptNoteDisplay">E5</div>
                    <div class="freq-display" id="scriptFreqDisplay">659.26 Hz</div>
                </div>
                <div class="script-delay-knob-wrap" id="scriptDelayKnobWrap"></div>
            </div>
            <div class="script-key-grid" id="scriptKeyGrid"></div>
            <div class="script-octave-row" id="scriptOctaveRow"></div>
            <div class="script-osc-row" id="scriptOscRow"></div>
            <div class="script-editor-actions">
                <button class="btn btn-danger" id="scriptDeleteBtn" onclick="deleteScriptNote()">Delete</button>
                <div style="flex: 1;"></div>
                <button class="btn btn-ghost" onclick="closeScriptNoteEditor()">Cancel</button>
                <button class="btn btn-primary" onclick="saveScriptNoteEdit()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tunajs@1.0.13/tuna.min.js"></script>
    <script>
// ============================================================
// BEEPKEEP - Audio Patch Editor
// North Star: Export 1:1 compatible patches for aggr-audio-service.ts
// ============================================================

// Musical notes lookup (includes sharps)
const NOTES = {
    'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
    'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
    'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.26, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
    'C6': 1046.50, 'C#6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51, 'E6': 1318.51, 'F6': 1396.91, 'F#6': 1479.98, 'G6': 1567.98, 'G#6': 1661.22, 'A6': 1760.00, 'A#6': 1864.66, 'B6': 1975.53
};

// Natural notes and sharps
const KEYS_NATURAL = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
const KEYS_SHARP = ['C#', 'D#', null, 'F#', 'G#', 'A#', null]; // null = no sharp (E→F, B→C)
const KEYS = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
const OCTAVES = [3, 4, 5, 6];
const OSC_TYPES = ['sine', 'triangle', 'square', 'sawtooth'];
const OSC_SVGS = {
    sine: '<svg viewBox="0 0 28 16"><path d="M2 8 Q7 2, 14 8 Q21 14, 26 8"/></svg>',
    triangle: '<svg viewBox="0 0 28 16"><path d="M2 8 L9 2 L16 14 L23 2 L26 8"/></svg>',
    square: '<svg viewBox="0 0 28 16"><path d="M2 12 L2 4 L9 4 L9 12 L16 12 L16 4 L23 4 L23 12 L26 12"/></svg>',
    sawtooth: '<svg viewBox="0 0 28 16"><path d="M2 12 L10 4 L10 12 L18 4 L18 12 L26 4"/></svg>'
};

// Scale definitions (semitone intervals from root)
const SCALES = {
    maj: { name: 'Maj', intervals: [0, 2, 4, 5, 7, 9, 11, 12] },
    min: { name: 'Min', intervals: [0, 2, 3, 5, 7, 8, 10, 12] },
    pentMaj: { name: 'Pent Maj', intervals: [0, 2, 4, 7, 9, 12] },
    pentMin: { name: 'Pent Min', intervals: [0, 3, 5, 7, 10, 12] },
    dim: { name: 'Dim', intervals: [0, 3, 6, 9, 12] },
    whole: { name: 'Whole', intervals: [0, 2, 4, 6, 8, 10, 12] },
    persian: { name: 'Persian', intervals: [0, 1, 4, 5, 6, 8, 11] }, // C-Db-E-F-Gb-Ab-B
    astley: { name: 'Astley', intervals: null } // Custom pattern
};

// Astley scale - melodic pattern from the iconic song
// Buy: "never gonna give you up" | Sell: "never gonna let you down"
const ASTLEY_PATTERNS = {
    buy: [
        { note: 'A4', delay: 0 },       // ne-
        { note: 'B4', delay: 0.18 },    // -ver
        { note: 'D5', delay: 0.36 },    // gon-
        { note: 'B4', delay: 0.54 },    // -na
        { note: 'F#5', delay: 0.72 },   // give
        { note: 'F#5', delay: 1.24 },   // you
        { note: 'E5', delay: 1.70 }     // up
    ],
    sell: [
        { note: 'A4', delay: 0 },       // ne-
        { note: 'B4', delay: 0.18 },    // -ver
        { note: 'D5', delay: 0.36 },    // gon-
        { note: 'B4', delay: 0.54 },    // -na
        { note: 'E5', delay: 0.72 },    // let
        { note: 'E5', delay: 1.24 },    // you
        { note: 'D5', delay: 1.70 },    // do-
        { note: 'C#5', delay: 1.78 },   // -o-
        { note: 'B4', delay: 1.87 }     // -own
    ]
};

// Astley position chords
const ASTLEY_CHORDS = {
    // Em9 ascending: E-G-B-D-F# (hopeful, building)
    openLong: [
        { frequency: 329.63, gain: 0.16, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0 },      // E4
        { frequency: 392.00, gain: 0.14, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.008 },  // G4
        { frequency: 493.88, gain: 0.13, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.016 },  // B4
        { frequency: 587.33, gain: 0.11, osc: 'sine', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.024 },      // D5
        { frequency: 739.99, gain: 0.10, osc: 'sine', fadeIn: 0.015, holdDuration: 0.28, fadeOut: 0.5, delay: 0.032 }        // F#5
    ],
    // A major descending: E-C#-A-E-A (bold, descending)
    openShort: [
        { frequency: 659.25, gain: 0.16, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0 },      // E5
        { frequency: 554.37, gain: 0.14, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.008 },  // C#5
        { frequency: 440.00, gain: 0.13, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.016 },  // A4
        { frequency: 329.63, gain: 0.11, osc: 'sine', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.024 },      // E4
        { frequency: 220.00, gain: 0.10, osc: 'sine', fadeIn: 0.015, holdDuration: 0.28, fadeOut: 0.5, delay: 0.032 }        // A3
    ],
    // F#m9 ascending: F#-A-C#-E-G# (triumphant, never let you down)
    closeProfit: [
        { frequency: 369.99, gain: 0.17, osc: 'triangle', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0 },       // F#4
        { frequency: 440.00, gain: 0.15, osc: 'triangle', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0.006 },   // A4
        { frequency: 554.37, gain: 0.14, osc: 'triangle', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0.012 },   // C#5
        { frequency: 659.25, gain: 0.12, osc: 'sine', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0.018 },       // E5
        { frequency: 830.61, gain: 0.10, osc: 'sine', fadeIn: 0.012, holdDuration: 0.35, fadeOut: 0.6, delay: 0.024 }        // G#5
    ],
    // Bm descending: F#-D-B-F#-B (melancholy, let you down)
    closeLoss: [
        { frequency: 739.99, gain: 0.16, osc: 'triangle', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0 },       // F#5
        { frequency: 587.33, gain: 0.14, osc: 'triangle', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0.010 },   // D5
        { frequency: 493.88, gain: 0.13, osc: 'triangle', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0.020 },   // B4
        { frequency: 369.99, gain: 0.11, osc: 'sine', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0.030 },       // F#4
        { frequency: 246.94, gain: 0.10, osc: 'sine', fadeIn: 0.018, holdDuration: 0.25, fadeOut: 0.55, delay: 0.040 }       // B3
    ]
};

// Level note counts: L0=1, L1=2, L2=3, L3=5 (standard), 1/3/5/7 for Astley & Persian
const LEVEL_NOTE_COUNTS = { 
    standard: [1, 2, 3, 5], 
    astley: { buy: [1, 3, 5, 7], sell: [1, 3, 5, 9] },
    persian: [1, 3, 5, 7]
};
const LEVEL_DELAYS = [[0], [0, 0.08], [0, 0.08, 0.16], [0, 0.08, 0.16, 0.32, 0.40]];
// Persian delays for 7 notes
const PERSIAN_DELAYS = [[0], [0, 0.08, 0.16], [0, 0.08, 0.16, 0.32, 0.40], [0, 0.08, 0.16, 0.32, 0.40, 0.48, 0.56]];

function freqToNote(freq) {
    let closest = 'A4';
    let minDiff = Infinity;
    for (const [note, f] of Object.entries(NOTES)) {
        const diff = Math.abs(f - freq);
        if (diff < minDiff) { minDiff = diff; closest = note; }
    }
    return closest;
}

// ============================================================
// STATE - Source of truth for export
// ============================================================
const state = {
    scripts: {
        thresholds: [
            { buy: 'play(659.26, gain / 10, 0.1 + gain / 7)', sell: 'play(493.88, gain * 1.5 / 10, 0.1 + gain / 7)' },
            { buy: 'play(659.26, 0.05 + gain / 10, 0.2 + ratio * 0.23,0,,0); play(830.6, 0.05 + gain / 10, 0.2 + ratio * 0.23, 0.08,,0)', sell: 'play(493.88, 0.05 + gain * 1.5 / 10, 0.2 + ratio * 0.23,0,,0); play(392, 0.05 + gain * 1.5 / 10, 0.2 + ratio * 0.23, 0.08,,0)' },
            { buy: 'play(659.26, 0.05 + gain / 25, 0.1 + ratio * 0.23, 0,,0); play(830.6, 0.05 + gain / 25, 0.1 + ratio * 0.23, 0.08,,0); play(987.76, 0.05 + gain / 25, 0.1 + ratio * 0.23, 0.16,,0); play(1318.52, 0.05 + gain / 10, 0.1 + ratio * 0.23, 0.24,,0)', sell: 'play(493.88, 0.05 + gain / 25, 0.1 + ratio * 0.23, 0,,0); play(369.99, 0.05 + gain * 1.5 / 10, 0.2, 0.08,,0); play(293.66, 0.05 + gain * 1.5 / 10, 0.2, 0.16,,0); play(246.94, 0.05 + gain * 1.5 / 10, 0.1 + ratio * 0.23, 0.24,,0)' },
            { buy: 'play(659.26, 0.05 + gain / 25, 0.1 + ratio * 0.13, 0,,0); play(830.6, 0.05 + gain / 25, 0.1 + ratio * 0.13, 0.08,,0); play(987.76, 0.05 + gain / 25, 0.1 + ratio * 0.13, 0.16,,0); play(1318.52, 0.05 + gain / 10, 0.1 + ratio * 0.13, 0.24,,0)', sell: 'play(493.88, 0.05 + gain / 25, 0.1 + ratio * 0.13, 0,,0); play(369.99, 0.05 + gain * 1.5 / 10, 0.2, 0.08,,0); play(293.66, 0.05 + gain * 1.5 / 10, 0.2, 0.16,,0); play(246.94, 0.05 + gain * 1.5 / 10, 0.1 + ratio * 0.13, 0.24,,0)' }
        ],
        liquidations: [
            { buy: "var srqtR = Math.min(1, gain / 4)\nplay(329.63, srqtR, srqtR*2,0,,,'sine')\nplay(329.63, srqtR, srqtR*4,0.08,,,'sine')", sell: "var srqtR = Math.min(1, gain / 6)\nplay(440, srqtR, srqtR*2,0,,,'sine')\nplay(440, srqtR, srqtR*4,0.08,,,'sine')" },
            { buy: "var srqtR = Math.min(1, gain / 4)\nplay(329.63, srqtR, srqtR*4,0,,,'sine')\nplay(329.63, srqtR, srqtR*6,0.08,,,'sine')", sell: "var srqtR = Math.min(1, gain / 6)\nplay(440, srqtR, srqtR*4,0,,,'sine')\nplay(440, srqtR, srqtR*6,0.08,,,'sine')" },
            { buy: "var srqtR = Math.min(1, gain / 4)\nplay(329.63, srqtR, srqtR*4,0,,,'sine')\nplay(329.63, srqtR, srqtR*8,0.08,,,'sine')", sell: "var srqtR = Math.min(1, gain / 6)\nplay(440, srqtR, srqtR*4,0,,,'sine')\nplay(440, srqtR, srqtR*8,0.08,,,'sine')" },
            { buy: "var srqtR = Math.min(1, gain / 10)\nplay(329.63, srqtR, 1,0,,,'sine')\nplay(329.63, srqtR, srqtR*10,0.08,,,'sine')", sell: "var srqtR = Math.min(1, gain / 10)\nplay(440, srqtR, 1,0,,,'sine')\nplay(440, srqtR, srqtR*10,0.08,,,'sine')" }
        ]
    },
    filters: {
        PingPongDelay: { enabled: true, wetLevel: 0.5, feedback: 0.01, delayTimeLeft: 175, delayTimeRight: 100 },
        HighPassFilter: { enabled: true, frequency: 700, Q: 10, gain: -10, filterType: 'highpass', bypass: 0 },
        LowPassFilter: { enabled: false, frequency: 1500, Q: 1, gain: 0, filterType: 'lowpass', bypass: 0 },
        Compressor: { enabled: false, threshold: -1, makeupGain: 1, attack: 1, release: 0, ratio: 4, knee: 5, automakeup: true, bypass: 0 },
        Delay: { enabled: false, feedback: 0.33, delayTime: 400 },
        Chorus: { enabled: false, rate: 1.5, feedback: 0.4, depth: 0.7, delay: 0.0045, bypass: 0 }
    },
    positions: {
        // CMaj9 ascending: C-E-G-B-D (warm, hopeful)
        openLong: [
            { frequency: 261.63, gain: 0.16, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0 },      // C4
            { frequency: 329.63, gain: 0.14, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.008 },  // E4
            { frequency: 392.00, gain: 0.13, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.016 },  // G4
            { frequency: 493.88, gain: 0.11, osc: 'sine', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.024 },      // B4
            { frequency: 587.33, gain: 0.10, osc: 'sine', fadeIn: 0.015, holdDuration: 0.28, fadeOut: 0.5, delay: 0.032 }        // D5
        ],
        // Amin9 descending: E-C-A-G-E (darker, cautious)
        openShort: [
            { frequency: 659.25, gain: 0.16, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0 },      // E5
            { frequency: 523.25, gain: 0.14, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.008 },  // C5
            { frequency: 440.00, gain: 0.13, osc: 'triangle', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.016 },  // A4
            { frequency: 392.00, gain: 0.11, osc: 'sine', fadeIn: 0.015, holdDuration: 0.25, fadeOut: 0.45, delay: 0.024 },      // G4
            { frequency: 329.63, gain: 0.10, osc: 'sine', fadeIn: 0.015, holdDuration: 0.28, fadeOut: 0.5, delay: 0.032 }        // E4
        ],
        // GMaj9 ascending: G-B-D-F#-A (bright, triumphant)
        closeProfit: [
            { frequency: 392.00, gain: 0.17, osc: 'triangle', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0 },       // G4
            { frequency: 493.88, gain: 0.15, osc: 'triangle', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0.006 },   // B4
            { frequency: 587.33, gain: 0.14, osc: 'triangle', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0.012 },   // D5
            { frequency: 739.99, gain: 0.12, osc: 'sine', fadeIn: 0.012, holdDuration: 0.3, fadeOut: 0.55, delay: 0.018 },       // F#5
            { frequency: 880.00, gain: 0.10, osc: 'sine', fadeIn: 0.012, holdDuration: 0.35, fadeOut: 0.6, delay: 0.024 }        // A5
        ],
        // Bdim7 descending: D-B-Ab-F-D (tense, failure)
        closeLoss: [
            { frequency: 587.33, gain: 0.16, osc: 'triangle', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0 },       // D5
            { frequency: 493.88, gain: 0.14, osc: 'triangle', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0.010 },   // B4
            { frequency: 415.30, gain: 0.13, osc: 'triangle', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0.020 },   // Ab4
            { frequency: 349.23, gain: 0.11, osc: 'sine', fadeIn: 0.018, holdDuration: 0.22, fadeOut: 0.5, delay: 0.030 },       // F4
            { frequency: 293.66, gain: 0.10, osc: 'sine', fadeIn: 0.018, holdDuration: 0.25, fadeOut: 0.55, delay: 0.040 }       // D4
        ]
    },
    ratios: { trade: 1, liq: 1 }
};

const AMOUNTS = {
    thresholds: ['$100K', '$250K', '$1M', '$10M'],
    liquidations: ['$50K', '$100K', '$200K', '$1M']
};

// ============================================================
// AUDIO ENGINE
// ============================================================
let audioContext = null;
let tuna = null;
let output = null;

async function initAudio() {
    if (audioContext) return true;
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') await audioContext.resume();
        tuna = new Tuna(audioContext);
        rebuildFilterChain();
        document.getElementById('audioLed').classList.add('active');
        document.getElementById('audioStatus').textContent = 'Audio Ready';
        document.getElementById('initAudioBtn').classList.add('active');
        showToast('Audio initialized');
        return true;
    } catch (e) {
        showToast('Audio error: ' + e.message);
        return false;
    }
}

function rebuildFilterChain() {
    if (!tuna) return;
    const effects = [];
    for (const [id, opts] of Object.entries(state.filters)) {
        if (!opts.enabled) continue;
        let name = (id === 'HighPassFilter' || id === 'LowPassFilter') ? 'Filter' : id;
        const params = { ...opts };
        delete params.enabled;
        if (tuna[name]) effects.push(new tuna[name](params));
    }
    const gainNode = new tuna.Gain({ gain: 1 });
    effects.push(gainNode);
    if (effects.length > 0) {
        let source = effects[0];
        for (const effect of effects.slice(1)) { source.connect(effect); source = effect; }
        source.connect(audioContext.destination);
        output = effects[0];
    } else {
        output = audioContext.destination;
    }
}

function playSound(options = {}) {
    if (!audioContext || audioContext.state !== 'running') return;
    const opts = { frequency: 329.63, gain: 1, fadeOut: 1, delay: 0, fadeIn: 0, holdDuration: 0, osc: 'triangle', startGain: 0.001, endGain: 0.001, ...options };
    setTimeout(() => {
        const t = audioContext.currentTime;
        const src = audioContext.createOscillator();
        const g = audioContext.createGain();
        src.frequency.value = opts.frequency;
        src.type = opts.osc;
        g.connect(output);
        src.connect(g);
        g.gain.setValueAtTime(opts.startGain, t);
        g.gain.linearRampToValueAtTime(opts.gain, t + opts.fadeIn);
        g.gain.setValueAtTime(opts.gain, t + opts.fadeIn + opts.holdDuration);
        g.gain.linearRampToValueAtTime(opts.endGain, t + opts.fadeIn + opts.holdDuration + opts.fadeOut);
        src.start(t);
        src.stop(t + opts.fadeIn + opts.holdDuration + opts.fadeOut + 0.1);
    }, opts.delay * 1000);
}

function executeScript(script, ratio, gainVal) {
    const play = (freq, g, fadeOut, delay, fadeIn, startGain, osc) => {
        playSound({
            frequency: freq || 440,
            gain: Math.min(1, Math.max(0, g || 0.5)),
            fadeOut: Math.max(0.05, fadeOut || 0.1),
            delay: delay || 0,
            fadeIn: fadeIn || 0,
            osc: (typeof osc === 'string' ? osc.replace(/'/g, '') : 'triangle') || 'triangle',
            startGain: startGain || 0.001,
            endGain: 0.001
        });
    };
    try {
        let normalized = script;
        for (let i = 0; i < 5; i++) normalized = normalized.replace(/,\s*,/g, ',undefined,');
        normalized = normalized.replace(/,\s*\)/g, ')');
        new Function('play', 'ratio', 'gain', normalized)(play, ratio, gainVal);
    } catch (e) { showToast('Script error: ' + e.message); }
}

function playTrade(level, side) {
    if (!audioContext) { initAudio(); return; }
    const script = state.scripts.thresholds[level]?.[side];
    if (!script) return;
    executeScript(script, state.ratios.trade, Math.sqrt(state.ratios.trade));
}

function playLiq(level, side) {
    if (!audioContext) { initAudio(); return; }
    const script = state.scripts.liquidations[level]?.[side];
    if (!script) return;
    executeScript(script, state.ratios.liq, Math.sqrt(state.ratios.liq));
}

function playAllTrades(side) {
    [0, 1, 2, 3].forEach((l, i) => setTimeout(() => playTrade(l, side), i * 600));
}

function playAllLiqs(side) {
    [0, 1, 2, 3].forEach((l, i) => setTimeout(() => playLiq(l, side), i * 600));
}

function playPositionSound(type) {
    if (!audioContext) { initAudio(); return; }
    state.positions[type].forEach(n => playSound(n));
}

// ============================================================
// UI RENDERING
// ============================================================

// Parse play() calls from script to visualize
function parsePlayCalls(script) {
    const calls = [];
    const regex = /play\s*\(\s*([^)]+)\)/g;
    let match;
    while ((match = regex.exec(script)) !== null) {
        const args = match[1].split(',').map(a => a.trim());
        const freq = parseFloat(args[0]) || 440;
        const delay = parseFloat(args[3]) || 0;
        // 7th arg (index 6) is oscillator type, strip quotes
        let osc = args[6] ? args[6].replace(/["']/g, '') : 'triangle';
        calls.push({ freq, note: freqToNote(freq), delay, osc });
    }
    return calls;
}

function renderTradeLanes() {
    const container = document.getElementById('tradeLanes');
    container.innerHTML = state.scripts.thresholds.map((s, i) => `
        <div class="sound-lane">
            <div class="lane-header">
                <div class="lane-info">
                    <span class="lane-badge level-${i}">L${i}</span>
                    <span class="lane-amount">${AMOUNTS.thresholds[i]}+</span>
                </div>
                <div class="lane-actions">
                    <button class="btn btn-play btn-icon" onclick="playTrade(${i}, 'buy')">▶</button>
                    <button class="btn btn-sell btn-icon" onclick="playTrade(${i}, 'sell')">▶</button>
                </div>
            </div>
            <div class="lane-body">
                <div class="lane-side">
                    <div class="lane-side-label buy">● Buy</div>
                    <div class="sound-blocks">
                        ${parsePlayCalls(s.buy).map((p, j) => `
                            <div class="sound-block" onclick="openScriptNoteEditor('thresholds', ${i}, 'buy', ${j}, ${p.freq})">
                                <span class="note">${p.note}</span>
                                <span class="timing">+${p.delay.toFixed(2)}s</span>
                                <span class="sound-block-remove" onclick="event.stopPropagation(); deleteScriptNoteDirect('thresholds', ${i}, 'buy', ${j})">✕</span>
                            </div>
                        `).join('')}
                        <button class="sound-block add-block" onclick="addScriptNote('thresholds', ${i}, 'buy')">+</button>
                    </div>
                </div>
                <div class="lane-side">
                    <div class="lane-side-label sell">● Sell</div>
                    <div class="sound-blocks">
                        ${parsePlayCalls(s.sell).map((p, j) => `
                            <div class="sound-block" onclick="openScriptNoteEditor('thresholds', ${i}, 'sell', ${j}, ${p.freq})">
                                <span class="note">${p.note}</span>
                                <span class="timing">+${p.delay.toFixed(2)}s</span>
                                <span class="sound-block-remove" onclick="event.stopPropagation(); deleteScriptNoteDirect('thresholds', ${i}, 'sell', ${j})">✕</span>
                            </div>
                        `).join('')}
                        <button class="sound-block add-block" onclick="addScriptNote('thresholds', ${i}, 'sell')">+</button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderLiqLanes() {
    const container = document.getElementById('liqLanes');
    container.innerHTML = state.scripts.liquidations.map((s, i) => `
        <div class="sound-lane">
            <div class="lane-header">
                <div class="lane-info">
                    <span class="lane-badge level-${i}">L${i}</span>
                    <span class="lane-amount">${AMOUNTS.liquidations[i]}+</span>
                </div>
                <div class="lane-actions">
                    <button class="btn btn-play btn-icon" onclick="playLiq(${i}, 'buy')">▶</button>
                    <button class="btn btn-sell btn-icon" onclick="playLiq(${i}, 'sell')">▶</button>
                </div>
            </div>
            <div class="lane-body">
                <div class="lane-side">
                    <div class="lane-side-label buy">● Buy</div>
                    <div class="sound-blocks">
                        ${parsePlayCalls(s.buy).map((p, j) => `
                            <div class="sound-block" onclick="openScriptNoteEditor('liquidations', ${i}, 'buy', ${j}, ${p.freq})">
                                <span class="note">${p.note}</span>
                                <span class="timing">+${p.delay.toFixed(2)}s</span>
                                <span class="sound-block-remove" onclick="event.stopPropagation(); deleteScriptNoteDirect('liquidations', ${i}, 'buy', ${j})">✕</span>
                            </div>
                        `).join('')}
                        <button class="sound-block add-block" onclick="addScriptNote('liquidations', ${i}, 'buy')">+</button>
                    </div>
                </div>
                <div class="lane-side">
                    <div class="lane-side-label sell">● Sell</div>
                    <div class="sound-blocks">
                        ${parsePlayCalls(s.sell).map((p, j) => `
                            <div class="sound-block" onclick="openScriptNoteEditor('liquidations', ${i}, 'sell', ${j}, ${p.freq})">
                                <span class="note">${p.note}</span>
                                <span class="timing">+${p.delay.toFixed(2)}s</span>
                                <span class="sound-block-remove" onclick="event.stopPropagation(); deleteScriptNoteDirect('liquidations', ${i}, 'sell', ${j})">✕</span>
                            </div>
                        `).join('')}
                        <button class="sound-block add-block" onclick="addScriptNote('liquidations', ${i}, 'sell')">+</button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Material Design icons for position chords
const CHORD_ICONS = {
    openLong: '<svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>',
    openShort: '<svg viewBox="0 0 24 24"><path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"/></svg>',
    closeProfit: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>',
    closeLoss: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/></svg>'
};

function renderChordBuilder() {
    const container = document.getElementById('chordBuilder');
    const configs = [
        { key: 'openLong', title: 'Open Long', cls: 'long' },
        { key: 'openShort', title: 'Open Short', cls: 'short' },
        { key: 'closeProfit', title: 'Close Profit', cls: 'profit' },
        { key: 'closeLoss', title: 'Close Loss', cls: 'loss' }
    ];
    
    container.innerHTML = configs.map(c => `
        <div class="chord-card">
            <div class="chord-card-header">
                <span class="chord-card-title ${c.cls}">${CHORD_ICONS[c.key]}${c.title}</span>
                <button class="btn btn-play btn-sm" onclick="playPositionSound('${c.key}')">▶ Play</button>
            </div>
            <div class="chord-card-body">
                <div class="sound-blocks" id="pills-${c.key}">
                    ${state.positions[c.key].map((n, i) => `
                        <div class="sound-block" data-type="${c.key}" data-idx="${i}" draggable="true" onclick="openNoteEditor('${c.key}', ${i})">
                            <span class="note">${freqToNote(n.frequency)}</span>
                            <span class="timing">+${n.delay.toFixed(2)}s</span>
                            <span class="sound-block-remove" onclick="event.stopPropagation(); deletePositionNoteDirect('${c.key}', ${i})">✕</span>
                        </div>
                    `).join('')}
                    <button class="sound-block add-block" onclick="openNoteEditor('${c.key}', -1)">+</button>
                </div>
            </div>
        </div>
    `).join('');
    
    // Setup drag and drop for each chord
    configs.forEach(c => setupNoteDrag(c.key));
}

function setupNoteDrag(type) {
    const container = document.getElementById(`pills-${type}`);
    let draggedIdx = null;
    
    container.querySelectorAll('.sound-block[data-idx]').forEach(block => {
        block.addEventListener('dragstart', (e) => {
            draggedIdx = parseInt(block.dataset.idx);
            block.classList.add('dragging');
        });
        
        block.addEventListener('dragend', () => {
            block.classList.remove('dragging');
            draggedIdx = null;
        });
        
        block.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (parseInt(block.dataset.idx) !== draggedIdx) {
                block.style.transform = 'scale(1.05)';
            }
        });
        
        block.addEventListener('dragleave', () => {
            block.style.transform = '';
        });
        
        block.addEventListener('drop', (e) => {
            e.preventDefault();
            block.style.transform = '';
            const targetIdx = parseInt(block.dataset.idx);
            if (draggedIdx !== null && draggedIdx !== targetIdx) {
                const notes = state.positions[type];
                const [moved] = notes.splice(draggedIdx, 1);
                notes.splice(targetIdx, 0, moved);
                renderChordBuilder();
            }
        });
    });
}

function renderFxRack() {
    const container = document.getElementById('fxRack');
    const filterConfigs = {
        PingPongDelay: [
            { key: 'wetLevel', label: 'Wet', min: 0, max: 1, step: 0.01 },
            { key: 'feedback', label: 'Feedback', min: 0, max: 1, step: 0.01 },
            { key: 'delayTimeLeft', label: 'L Delay', min: 1, max: 500, step: 1 },
            { key: 'delayTimeRight', label: 'R Delay', min: 1, max: 500, step: 1 }
        ],
        HighPassFilter: [
            { key: 'frequency', label: 'Freq', min: 20, max: 5000, step: 10 },
            { key: 'Q', label: 'Q', min: 0.001, max: 30, step: 0.1 },
            { key: 'gain', label: 'Gain', min: -40, max: 40, step: 1 }
        ],
        LowPassFilter: [
            { key: 'frequency', label: 'Freq', min: 20, max: 5000, step: 10 },
            { key: 'Q', label: 'Q', min: 0.001, max: 30, step: 0.1 },
            { key: 'gain', label: 'Gain', min: -40, max: 40, step: 1 }
        ],
        Compressor: [
            { key: 'threshold', label: 'Thresh', min: -100, max: 0, step: 1 },
            { key: 'ratio', label: 'Ratio', min: 1, max: 20, step: 1 },
            { key: 'attack', label: 'Attack', min: 0, max: 1000, step: 10 },
            { key: 'release', label: 'Release', min: 0, max: 3000, step: 10 }
        ],
        Delay: [
            { key: 'feedback', label: 'Feedback', min: 0, max: 1, step: 0.01 },
            { key: 'delayTime', label: 'Time', min: 1, max: 1000, step: 10 }
        ],
        Chorus: [
            { key: 'rate', label: 'Rate', min: 0.01, max: 8, step: 0.1 },
            { key: 'feedback', label: 'Feedback', min: 0, max: 1, step: 0.01 },
            { key: 'depth', label: 'Depth', min: 0, max: 1, step: 0.01 }
        ]
    };
    
    const displayNames = {
        PingPongDelay: 'PONGUS',
        HighPassFilter: 'DE-FART',
        LowPassFilter: 'DE-SCREECH',
        Compressor: 'SQUASHY BOI',
        Delay: 'BOINGUS',
        Chorus: 'SPOOP'
    };
    
    container.innerHTML = Object.entries(filterConfigs).map(([name, params]) => `
        <div class="fx-pedal ${state.filters[name].enabled ? 'active' : ''}" data-filter="${name}">
            <div class="fx-pedal-header">
                <div class="fx-pedal-name">
                    <div class="led ${state.filters[name].enabled ? 'active' : ''}"></div>
                    <span>${displayNames[name]}</span>
                </div>
                <div class="power-switch ${state.filters[name].enabled ? 'on' : ''}" data-filter="${name}"></div>
            </div>
            <div class="fx-pedal-knobs">
                ${params.map(p => {
                    const val = state.filters[name][p.key];
                    const pct = ((val - p.min) / (p.max - p.min)) * 100;
                    const angle = (pct / 100) * 270;
                    const rotation = -135 + angle;
                    const circumference = 2 * Math.PI * 18;
                    const dashLength = (pct / 100) * 0.75 * circumference;
                    const intensity = 0.3 + (pct / 100) * 0.7;
                    return `
                    <div class="knob-group">
                        <div class="knob sm" data-filter="${name}" data-key="${p.key}" data-min="${p.min}" data-max="${p.max}" data-step="${p.step}">
                            <div class="knob-track"></div>
                            <svg class="knob-arc" viewBox="0 0 44 44" style="--arc-intensity: ${intensity}">
                                <circle cx="22" cy="22" r="18" stroke-dasharray="${dashLength} ${circumference}" />
                            </svg>
                            <div class="knob-cap">
                                <div class="knob-indicator" style="--rotation: ${rotation}"></div>
                            </div>
                        </div>
                        <span class="knob-value">${typeof val === 'number' ? (val < 10 ? val.toFixed(2) : Math.round(val)) : val}</span>
                        <span class="knob-label">${p.label}</span>
                    </div>
                `}).join('')}
            </div>
        </div>
    `).join('');
    
    // Power switch handlers
    container.querySelectorAll('.power-switch').forEach(sw => {
        sw.addEventListener('click', () => {
            const filter = sw.dataset.filter;
            state.filters[filter].enabled = !state.filters[filter].enabled;
            
            // Update just the visual state without re-rendering (preserves transitions)
            const pedal = sw.closest('.fx-pedal');
            const led = pedal.querySelector('.led');
            if (state.filters[filter].enabled) {
                pedal.classList.add('active');
                led.classList.add('active');
                sw.classList.add('on');
            } else {
                pedal.classList.remove('active');
                led.classList.remove('active');
                sw.classList.remove('on');
            }
            
            if (audioContext) rebuildFilterChain();
        });
    });
    
    // Knob interaction
    setupKnobs();
}

function setupKnobs() {
    document.querySelectorAll('.knob').forEach(knob => {
        let isDragging = false;
        let startY, startValue;
        
        knob.addEventListener('mousedown', (e) => {
            isDragging = true;
            startY = e.clientY;
            const { filter, key, min, max } = knob.dataset;
            startValue = state.filters[filter][key];
            document.body.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const { filter, key, min, max, step } = knob.dataset;
            const delta = (startY - e.clientY) * parseFloat(step) * 2;
            let newVal = startValue + delta;
            newVal = Math.max(parseFloat(min), Math.min(parseFloat(max), newVal));
            state.filters[filter][key] = newVal;
            
            // Update visual
            const pct = ((newVal - parseFloat(min)) / (parseFloat(max) - parseFloat(min))) * 100;
            const angle = (pct / 100) * 270;
            const rotation = -135 + angle;
            const circumference = 2 * Math.PI * 18;
            const dashLength = (pct / 100) * 0.75 * circumference;
            const intensity = 0.3 + (pct / 100) * 0.7;
            const arc = knob.querySelector('.knob-arc');
            arc.style.setProperty('--arc-intensity', intensity);
            arc.querySelector('circle').setAttribute('stroke-dasharray', `${dashLength} ${circumference}`);
            knob.querySelector('.knob-indicator').style.setProperty('--rotation', rotation);
            knob.closest('.knob-group').querySelector('.knob-value').textContent = 
                newVal < 10 ? newVal.toFixed(2) : Math.round(newVal);
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
                if (audioContext) rebuildFilterChain();
            }
        });
    });
}

// ============================================================
// NOTE EDITOR
// ============================================================
let editingNote = { type: null, idx: -1 };
let editorState = { key: 'A', octave: 4, gain: 0.5, osc: 'triangle', fadeIn: 0.01, holdDuration: 0.1, fadeOut: 0.25, delay: 0 };

function openNoteEditor(type, idx) {
    editingNote = { type, idx };
    
    if (idx >= 0) {
        const note = state.positions[type][idx];
        const noteName = freqToNote(note.frequency);
        editorState = {
            key: noteName.slice(0, -1),
            octave: parseInt(noteName.slice(-1)),
            gain: note.gain,
            osc: note.osc,
            fadeIn: note.fadeIn,
            holdDuration: note.holdDuration,
            fadeOut: note.fadeOut,
            delay: note.delay
        };
    } else {
        editorState = { key: 'A', octave: 4, gain: 0.5, osc: 'triangle', fadeIn: 0.01, holdDuration: 0.1, fadeOut: 0.25, delay: 0 };
    }
    
    renderNoteEditor();
    document.getElementById('noteEditor').classList.add('open');
}

function closeNoteEditor() {
    document.getElementById('noteEditor').classList.remove('open');
}

function renderNoteEditor() {
    // Cleanup any existing knob handlers before re-rendering
    cleanupEditorKnobs();
    
    // Key selector - piano style with sharps row above naturals
    const sharpsRow = KEYS_SHARP.map((k, i) => {
        if (k === null) return `<button class="key-btn spacer"></button>`;
        return `<button class="key-btn sharp ${editorState.key === k ? 'selected' : ''}" onclick="selectKey('${k}')">${k}</button>`;
    }).join('');
    const naturalsRow = KEYS_NATURAL.map(k => 
        `<button class="key-btn ${editorState.key === k ? 'selected' : ''}" onclick="selectKey('${k}')">${k}</button>`
    ).join('');
    document.getElementById('keySelector').innerHTML = `
        <div class="key-row sharps">${sharpsRow}</div>
        <div class="key-row">${naturalsRow}</div>
    `;
    
    // Octave selector
    document.getElementById('octaveSelector').innerHTML = OCTAVES.map(o => 
        `<button class="octave-btn ${editorState.octave === o ? 'selected' : ''}" onclick="selectOctave(${o})">${o}</button>`
    ).join('');
    
    // Oscillator selector
    document.getElementById('oscSelector').innerHTML = OSC_TYPES.map(o => 
        `<button class="osc-btn ${editorState.osc === o ? 'selected' : ''}" onclick="selectOsc('${o}')">${OSC_SVGS[o]}</button>`
    ).join('');
    
    // Editor knobs (gain, fadeIn, hold, fadeOut, delay)
    const knobConfigs = [
        { key: 'gain', label: 'Gain', min: 0, max: 1, step: 0.01 },
        { key: 'fadeIn', label: 'Fade In', min: 0, max: 0.5, step: 0.005 },
        { key: 'holdDuration', label: 'Hold', min: 0, max: 1, step: 0.01 },
        { key: 'fadeOut', label: 'Fade Out', min: 0, max: 1, step: 0.01 },
        { key: 'delay', label: 'Delay', min: 0, max: 1, step: 0.01 }
    ];
    
    document.getElementById('editorKnobs').innerHTML = knobConfigs.map(p => {
        const val = editorState[p.key];
        const pct = ((val - p.min) / (p.max - p.min)) * 100;
        const angle = (pct / 100) * 270;
        const rotation = -135 + angle;
        const circumference = 2 * Math.PI * 18;
        const dashLength = (pct / 100) * 0.75 * circumference;
        const intensity = 0.3 + (pct / 100) * 0.7;
        return `
            <div class="knob-group">
                <div class="knob sm editor-knob" data-key="${p.key}" data-min="${p.min}" data-max="${p.max}" data-step="${p.step}">
                    <div class="knob-track"></div>
                    <svg class="knob-arc" viewBox="0 0 44 44" style="--arc-intensity: ${intensity}">
                        <circle cx="22" cy="22" r="18" stroke-dasharray="${dashLength} ${circumference}" />
                    </svg>
                    <div class="knob-cap">
                        <div class="knob-indicator" style="--rotation: ${rotation}"></div>
                    </div>
                </div>
                <span class="knob-value">${val.toFixed(2)}</span>
                <span class="knob-label">${p.label}</span>
            </div>
        `;
    }).join('');
    
    // Show/hide delete button
    const noteCount = state.positions[editingNote.type]?.length || 0;
    const deleteBtn = document.getElementById('noteDeleteBtn');
    deleteBtn.style.display = (editingNote.idx >= 0 && noteCount > 1) ? '' : 'none';
    
    // Setup editor knob interaction
    setupEditorKnobs();
}

function setupEditorKnobs() {
    document.querySelectorAll('.editor-knob').forEach(knob => {
        let isDragging = false;
        let startY, startValue;
        
        const downHandler = (e) => {
            isDragging = true;
            startY = e.clientY;
            startValue = editorState[knob.dataset.key];
            document.body.style.cursor = 'grabbing';
        };
        
        const moveHandler = (e) => {
            if (!isDragging) return;
            const { key, min, max, step } = knob.dataset;
            const delta = (startY - e.clientY) * parseFloat(step) * 2;
            let newVal = startValue + delta;
            newVal = Math.max(parseFloat(min), Math.min(parseFloat(max), newVal));
            editorState[key] = newVal;
            
            const pct = ((newVal - parseFloat(min)) / (parseFloat(max) - parseFloat(min))) * 100;
            const angle = (pct / 100) * 270;
            const rotation = -135 + angle;
            const circumference = 2 * Math.PI * 18;
            const dashLength = (pct / 100) * 0.75 * circumference;
            const intensity = 0.3 + (pct / 100) * 0.7;
            const arc = knob.querySelector('.knob-arc');
            arc.style.setProperty('--arc-intensity', intensity);
            arc.querySelector('circle').setAttribute('stroke-dasharray', `${dashLength} ${circumference}`);
            knob.querySelector('.knob-indicator').style.setProperty('--rotation', rotation);
            knob.closest('.knob-group').querySelector('.knob-value').textContent = newVal.toFixed(2);
        };
        
        const upHandler = () => {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
            }
        };
        
        knob.addEventListener('mousedown', downHandler);
        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', upHandler);
        
        // Store cleanup function on the knob element
        knob._cleanup = () => {
            knob.removeEventListener('mousedown', downHandler);
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('mouseup', upHandler);
        };
    });
}

function cleanupEditorKnobs() {
    document.querySelectorAll('.editor-knob').forEach(knob => {
        if (knob._cleanup) knob._cleanup();
    });
}

function selectKey(k) {
    editorState.key = k;
    renderNoteEditor();
    // Preview
    const freq = NOTES[editorState.key + editorState.octave] || 440;
    if (audioContext) playSound({ frequency: freq, gain: 0.3, fadeOut: 0.2, osc: editorState.osc });
}

function selectOctave(o) {
    editorState.octave = o;
    renderNoteEditor();
    // Preview
    const freq = NOTES[editorState.key + editorState.octave] || 440;
    if (audioContext) playSound({ frequency: freq, gain: 0.3, fadeOut: 0.2, osc: editorState.osc });
}

function selectOsc(o) {
    editorState.osc = o;
    renderNoteEditor();
    // Preview
    const freq = NOTES[editorState.key + editorState.octave] || 440;
    if (audioContext) playSound({ frequency: freq, gain: 0.3, fadeOut: 0.2, osc: editorState.osc });
}

function saveNoteEdit() {
    const noteName = editorState.key + editorState.octave;
    const freq = NOTES[noteName] || 440;
    
    const noteData = {
        frequency: freq,
        gain: editorState.gain,
        osc: editorState.osc,
        fadeIn: editorState.fadeIn,
        holdDuration: editorState.holdDuration,
        fadeOut: editorState.fadeOut,
        delay: editorState.delay
    };
    
    if (editingNote.idx >= 0) {
        state.positions[editingNote.type][editingNote.idx] = noteData;
    } else {
        state.positions[editingNote.type].push(noteData);
    }
    
    closeNoteEditor();
    renderChordBuilder();
}

function removeNote(type, idx) {
    state.positions[type].splice(idx, 1);
    renderChordBuilder();
}

function deletePositionNote() {
    const { type, idx } = editingNote;
    if (idx < 0) return; // Can't delete a new note
    
    const noteCount = state.positions[type].length;
    if (noteCount <= 1) {
        showToast('Cannot delete last note', 'error');
        return;
    }
    
    state.positions[type].splice(idx, 1);
    closeNoteEditor();
    renderChordBuilder();
    showToast('Note deleted');
}

// ============================================================
// SCRIPT NOTE EDITOR (for trades/liqs)
// ============================================================
let scriptNoteEditing = { category: null, level: -1, side: null, noteIdx: -1, originalFreq: 0, originalDelay: 0 };
let scriptNoteState = { key: 'E', octave: 5, delay: 0, osc: 'triangle' };

function openScriptNoteEditor(category, level, side, noteIdx, freq) {
    // Parse the delay and osc from the script
    const script = state.scripts[category][level][side];
    const parsed = parsePlayCalls(script);
    const delay = parsed[noteIdx]?.delay || 0;
    const osc = parsed[noteIdx]?.osc || 'triangle';
    
    scriptNoteEditing = { category, level, side, noteIdx, originalFreq: freq, originalDelay: delay };
    
    // Parse current note from frequency
    const noteName = freqToNote(freq);
    scriptNoteState = {
        key: noteName.slice(0, -1),
        octave: parseInt(noteName.slice(-1)),
        delay: delay,
        osc: osc
    };
    
    renderScriptNoteEditor();
    document.getElementById('scriptNoteEditor').classList.add('open');
}

function closeScriptNoteEditor() {
    document.getElementById('scriptNoteEditor').classList.remove('open');
}

function renderScriptNoteEditor() {
    const noteName = scriptNoteState.key + scriptNoteState.octave;
    const freq = NOTES[noteName] || 440;
    
    document.getElementById('scriptNoteDisplay').textContent = noteName;
    document.getElementById('scriptFreqDisplay').textContent = freq.toFixed(2) + ' Hz';
    
    // Delay knob (max 2 sec)
    const delayVal = scriptNoteState.delay;
    const delayPct = (delayVal / 2) * 100;
    const delayAngle = (delayPct / 100) * 270;
    const delayRotation = -135 + delayAngle;
    const circumference = 2 * Math.PI * 18;
    const dashLength = (delayPct / 100) * 0.75 * circumference;
    const intensity = 0.3 + (delayPct / 100) * 0.7;
    
    document.getElementById('scriptDelayKnobWrap').innerHTML = `
        <div class="knob sm script-delay-knob" data-min="0" data-max="2" data-step="0.01">
            <div class="knob-track"></div>
            <svg class="knob-arc" viewBox="0 0 44 44" style="--arc-intensity: ${intensity}">
                <circle cx="22" cy="22" r="18" stroke-dasharray="${dashLength} ${circumference}" />
            </svg>
            <div class="knob-cap">
                <div class="knob-indicator" style="--rotation: ${delayRotation}"></div>
            </div>
        </div>
        <span class="knob-value">${delayVal.toFixed(2)}s</span>
        <span class="knob-label">Delay</span>
    `;
    setupScriptDelayKnob();
    
    // Key grid - piano style with sharps row above naturals
    const sharpsRow = KEYS_SHARP.map((k, i) => {
        if (k === null) return `<button class="script-key-btn spacer"></button>`;
        return `<button class="script-key-btn sharp ${scriptNoteState.key === k ? 'selected' : ''}" onclick="selectScriptKey('${k}')">${k}</button>`;
    }).join('');
    const naturalsRow = KEYS_NATURAL.map(k => 
        `<button class="script-key-btn ${scriptNoteState.key === k ? 'selected' : ''}" onclick="selectScriptKey('${k}')">${k}</button>`
    ).join('');
    document.getElementById('scriptKeyGrid').innerHTML = `
        <div class="script-key-row sharps">${sharpsRow}</div>
        <div class="script-key-row">${naturalsRow}</div>
    `;
    
    // Octave row
    document.getElementById('scriptOctaveRow').innerHTML = OCTAVES.map(o => 
        `<button class="script-octave-btn ${scriptNoteState.octave === o ? 'selected' : ''}" onclick="selectScriptOctave(${o})">${o}</button>`
    ).join('');
    
    // Oscillator row
    document.getElementById('scriptOscRow').innerHTML = OSC_TYPES.map(o => 
        `<button class="script-osc-btn ${scriptNoteState.osc === o ? 'selected' : ''}" onclick="selectScriptOsc('${o}')">${OSC_SVGS[o]}</button>`
    ).join('');
    
    // Show/hide delete button based on note count
    const { category, level, side } = scriptNoteEditing;
    const noteCount = parsePlayCalls(state.scripts[category][level][side]).length;
    document.getElementById('scriptDeleteBtn').style.display = noteCount > 1 ? '' : 'none';
}

function setupScriptDelayKnob() {
    const knob = document.querySelector('.script-delay-knob');
    if (!knob) return;
    let isDragging = false;
    let startY, startValue;
    
    knob.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.clientY;
        startValue = scriptNoteState.delay;
    });
    
    const moveHandler = (e) => {
        if (!isDragging) return;
        const delta = (startY - e.clientY) * 0.01;
        let newVal = startValue + delta;
        newVal = Math.max(0, Math.min(2, newVal));
        scriptNoteState.delay = newVal;
        
        const pct = (newVal / 2) * 100;
        const angle = (pct / 100) * 270;
        const rotation = -135 + angle;
        const circumference = 2 * Math.PI * 18;
        const dashLen = (pct / 100) * 0.75 * circumference;
        const intensity = 0.3 + (pct / 100) * 0.7;
        
        const arc = knob.querySelector('.knob-arc');
        arc.style.setProperty('--arc-intensity', intensity);
        arc.querySelector('circle').setAttribute('stroke-dasharray', `${dashLen} ${circumference}`);
        knob.querySelector('.knob-indicator').style.setProperty('--rotation', rotation);
        knob.closest('.script-delay-knob-wrap').querySelector('.knob-value').textContent = newVal.toFixed(2) + 's';
    };
    
    const upHandler = () => { isDragging = false; };
    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', upHandler);
}

function selectScriptKey(k) {
    scriptNoteState.key = k;
    renderScriptNoteEditor();
    // Preview sound with current osc
    const noteName = scriptNoteState.key + scriptNoteState.octave;
    const freq = NOTES[noteName] || 440;
    if (audioContext) playSound({ frequency: freq, gain: 0.3, fadeOut: 0.3, osc: scriptNoteState.osc });
}

function selectScriptOctave(o) {
    scriptNoteState.octave = o;
    renderScriptNoteEditor();
    // Preview sound with current osc
    const noteName = scriptNoteState.key + scriptNoteState.octave;
    const freq = NOTES[noteName] || 440;
    if (audioContext) playSound({ frequency: freq, gain: 0.3, fadeOut: 0.3, osc: scriptNoteState.osc });
}

function selectScriptOsc(o) {
    scriptNoteState.osc = o;
    renderScriptNoteEditor();
    // Preview sound with new osc
    const noteName = scriptNoteState.key + scriptNoteState.octave;
    const freq = NOTES[noteName] || 440;
    if (audioContext) playSound({ frequency: freq, gain: 0.3, fadeOut: 0.3, osc: scriptNoteState.osc });
}

function saveScriptNoteEdit() {
    const { category, level, side, noteIdx } = scriptNoteEditing;
    const noteName = scriptNoteState.key + scriptNoteState.octave;
    const newFreq = NOTES[noteName] || 440;
    const newDelay = scriptNoteState.delay;
    const newOsc = scriptNoteState.osc;
    
    // Get the script string
    let script = state.scripts[category][level][side];
    
    // Find and replace the Nth play() call's frequency, delay, and osc
    // play(freq, gain, fadeOut, delay, fadeIn, holdDuration, osc)
    let count = 0;
    script = script.replace(/play\s*\(([^)]+)\)/g, (match, argsStr) => {
        if (count === noteIdx) {
            count++;
            const args = argsStr.split(',').map(a => a.trim());
            args[0] = newFreq.toString(); // frequency
            // Ensure we have at least 7 args for osc
            while (args.length < 7) args.push('0');
            args[3] = newDelay.toString(); // delay
            args[6] = `'${newOsc}'`; // oscillator type
            return `play(${args.join(', ')})`;
        }
        count++;
        return match;
    });
    
    // Update state
    state.scripts[category][level][side] = script;
    
    closeScriptNoteEditor();
    
    // Re-render the appropriate lane
    if (category === 'thresholds') {
        renderTradeLanes();
    } else {
        renderLiqLanes();
    }
    
    showToast(`${noteName} ${newOsc} @ +${newDelay.toFixed(2)}s`);
}

function addScriptNote(category, level, side) {
    // Determine default osc based on category
    const defaultOsc = category === 'liquidations' ? 'sine' : 'triangle';
    
    // Get current script to find max delay for new note
    const script = state.scripts[category][level][side];
    const parsed = parsePlayCalls(script);
    const maxDelay = parsed.length > 0 ? Math.max(...parsed.map(p => p.delay)) + 0.08 : 0;
    
    // Add new play() call with default A4, 0.3 gain, 0.3 fadeOut
    const newCall = `play(440, 0.3, 0.3, ${maxDelay.toFixed(2)}, 0, 0, '${defaultOsc}')`;
    state.scripts[category][level][side] = script + (script.trim() ? '; ' : '') + newCall;
    
    // Re-render
    if (category === 'thresholds') {
        renderTradeLanes();
    } else {
        renderLiqLanes();
    }
    
    showToast(`Added A4 @ +${maxDelay.toFixed(2)}s`);
}

function deleteScriptNote() {
    const { category, level, side, noteIdx } = scriptNoteEditing;
    
    // Get current script
    let script = state.scripts[category][level][side];
    const parsed = parsePlayCalls(script);
    
    // Don't allow deleting if only one note
    if (parsed.length <= 1) {
        showToast('Cannot delete last note', 'error');
        return;
    }
    
    // Remove the Nth play() call
    let count = 0;
    script = script.replace(/play\s*\([^)]+\)\s*;?\s*/g, (match) => {
        if (count === noteIdx) {
            count++;
            return '';
        }
        count++;
        return match;
    });
    
    // Clean up any leading/trailing semicolons and spaces
    script = script.replace(/^\s*;\s*/, '').replace(/\s*;\s*$/, '').replace(/;\s*;/g, ';').trim();
    
    state.scripts[category][level][side] = script;
    
    closeScriptNoteEditor();
    
    if (category === 'thresholds') {
        renderTradeLanes();
    } else {
        renderLiqLanes();
    }
    
    showToast('Note deleted');
}

function deleteScriptNoteDirect(category, level, side, noteIdx) {
    // Get current script
    let script = state.scripts[category][level][side];
    const parsed = parsePlayCalls(script);
    
    // Don't allow deleting if only one note
    if (parsed.length <= 1) {
        showToast('Cannot delete last note', 'error');
        return;
    }
    
    // Remove the Nth play() call
    let count = 0;
    script = script.replace(/play\s*\([^)]+\)\s*;?\s*/g, (match) => {
        if (count === noteIdx) {
            count++;
            return '';
        }
        count++;
        return match;
    });
    
    // Clean up any leading/trailing semicolons and spaces
    script = script.replace(/^\s*;\s*/, '').replace(/\s*;\s*$/, '').replace(/;\s*;/g, ';').trim();
    
    state.scripts[category][level][side] = script;
    
    if (category === 'thresholds') {
        renderTradeLanes();
    } else {
        renderLiqLanes();
    }
    
    showToast('Note deleted');
}

function deletePositionNoteDirect(type, idx) {
    const noteCount = state.positions[type].length;
    if (noteCount <= 1) {
        showToast('Cannot delete last note', 'error');
        return;
    }
    
    state.positions[type].splice(idx, 1);
    renderChordBuilder();
    showToast('Note deleted');
}

// ============================================================
// EXPORT / VALIDATION
// ============================================================
function validatePatch() {
    const errors = [];
    const warnings = [];

    if (state.scripts.thresholds.length !== 4) errors.push(`thresholds must have 4 levels`);
    if (state.scripts.liquidations.length !== 4) errors.push(`liquidations must have 4 levels`);

    state.scripts.thresholds.forEach((s, i) => {
        if (typeof s.buy !== 'string') errors.push(`thresholds[${i}].buy must be string`);
        if (typeof s.sell !== 'string') errors.push(`thresholds[${i}].sell must be string`);
    });

    ['openLong', 'openShort', 'closeProfit', 'closeLoss'].forEach(type => {
        if (!Array.isArray(state.positions[type])) errors.push(`positions.${type} must be array`);
        else if (state.positions[type].length === 0) warnings.push(`positions.${type} has no notes`);
    });

    return { valid: errors.length === 0, errors, warnings };
}

function generatePatch() {
    const enabledFilters = Object.entries(state.filters).filter(([_, v]) => v.enabled).map(([k]) => k);
    
    const filterOptionsObj = {};
    for (const [name, opts] of Object.entries(state.filters)) {
        const clean = { ...opts };
        delete clean.enabled;
        filterOptionsObj[name] = clean;
    }

    return `// ============================================================
// BEEPKEEP AUDIO PATCH
// Generated: ${new Date().toISOString()}
// Target: defi-app-react-app/src/services/aggr-audio-service.ts
// ============================================================

// --- STEP 1: Replace AGGR_DEFAULT_SCRIPTS (around line 78) ---
const AGGR_DEFAULT_SCRIPTS: { thresholds: ScriptPreset[]; liquidations: ScriptPreset[] } = {
  thresholds: [
${state.scripts.thresholds.map(s => `    {
      buy: ${JSON.stringify(s.buy)},
      sell: ${JSON.stringify(s.sell)},
    }`).join(',\n')}
  ],
  liquidations: [
${state.scripts.liquidations.map(s => `    {
      buy: ${JSON.stringify(s.buy)},
      sell: ${JSON.stringify(s.sell)},
    }`).join(',\n')}
  ],
};

// --- STEP 2: Replace FILTERS_OPTIONS (around line 164) ---
const FILTERS_OPTIONS = ${JSON.stringify(filterOptionsObj, null, 2).replace(/"([^"]+)":/g, '$1:')};

// --- STEP 3: Update enabled filters in connect() method ---
const enabledFilters = ${JSON.stringify(enabledFilters)};

// --- STEP 4: Position sounds ---
const openLongSounds = ${JSON.stringify(state.positions.openLong, null, 2)};
const openShortSounds = ${JSON.stringify(state.positions.openShort, null, 2)};
const closeProfitSounds = ${JSON.stringify(state.positions.closeProfit, null, 2)};
const closeLossSounds = ${JSON.stringify(state.positions.closeLoss, null, 2)};
`;
}

function renderExport() {
    const validation = validatePatch();
    const statusEl = document.getElementById('validationStatus');
    const detailsEl = document.getElementById('validationDetails');
    const previewEl = document.getElementById('patchPreview');

    statusEl.className = 'validation-status ' + (validation.valid ? 'valid' : 'invalid');
    detailsEl.innerHTML = validation.valid 
        ? '<span style="color: var(--positive);">All checks passed</span>'
        : validation.errors.map(e => `<div style="color: var(--negative);">✕ ${e}</div>`).join('');
    
    previewEl.textContent = validation.valid ? generatePatch() : '// Fix validation errors first';
}

function copyPatch() {
    if (!validatePatch().valid) { showToast('Fix errors first'); return; }
    navigator.clipboard.writeText(generatePatch());
    showToast('Patch copied');
}

function downloadPatch() {
    if (!validatePatch().valid) { showToast('Fix errors first'); return; }
    const blob = new Blob([generatePatch()], { type: 'text/typescript' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `beepkeep-patch-${new Date().toISOString().slice(0,10)}.ts`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Downloaded');
}

function saveToBrowser() {
    localStorage.setItem('beepkeepState', JSON.stringify(state));
    showToast('Saved locally');
}

function loadFromBrowser() {
    const saved = localStorage.getItem('beepkeepState');
    if (saved) {
        Object.assign(state, JSON.parse(saved));
        renderAll();
        showToast('Loaded');
    } else {
        showToast('No saved state');
    }
}

function loadFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            let content = e.target.result;
            
            // If it's a .ts file, try to extract the config object
            if (file.name.endsWith('.ts')) {
                // Look for the audioPatch export or config object
                const configMatch = content.match(/export\s+const\s+audioPatch\s*=\s*({[\s\S]*?});?\s*$/) ||
                                   content.match(/const\s+config\s*=\s*({[\s\S]*?});/);
                if (configMatch) {
                    // Convert to valid JSON by fixing property names
                    let jsonStr = configMatch[1]
                        .replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":')
                        .replace(/'/g, '"')
                        .replace(/,\s*}/g, '}')
                        .replace(/,\s*]/g, ']');
                    content = jsonStr;
                }
            }
            
            const parsed = JSON.parse(content);
            
            // Validate structure
            if (parsed.trades && parsed.liquidations && parsed.positionEvents && parsed.filters) {
                Object.assign(state, parsed);
                renderAll();
                showToast('Loaded: ' + file.name);
            } else {
                showToast('Invalid schema structure');
            }
        } catch (err) {
            console.error('Parse error:', err);
            showToast('Failed to parse file');
        }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset for re-upload
}

function showToast(msg) {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}

// ============================================================
// RATIO SLIDER
// ============================================================
function setupRatioSlider(trackId, valueId, stateKey) {
    const track = document.getElementById(trackId);
    const valueEl = document.getElementById(valueId);
    let isDragging = false;
    
    const updateRatio = (e) => {
        const rect = track.getBoundingClientRect();
        let pct = (e.clientX - rect.left) / rect.width;
        pct = Math.max(0, Math.min(1, pct));
        let ratio = 0.1 + pct * 2.9; // 0.1 to 3.0
        
        // Snap to 1.0 when within ±0.08 range
        if (ratio > 0.92 && ratio < 1.08) {
            ratio = 1.0;
            pct = (1.0 - 0.1) / 2.9; // recalc pct for visual
        }
        
        state.ratios[stateKey] = ratio;
        track.querySelector('.ratio-fill').style.width = (pct * 100) + '%';
        track.querySelector('.ratio-thumb').style.left = (pct * 100) + '%';
        valueEl.textContent = ratio.toFixed(2);
    };
    
    track.addEventListener('mousedown', (e) => {
        isDragging = true;
        updateRatio(e);
    });
    
    document.addEventListener('mousemove', (e) => {
        if (isDragging) updateRatio(e);
    });
    
    document.addEventListener('mouseup', () => {
        isDragging = false;
    });
}

// ============================================================
// SCALE SELECTOR
// ============================================================
const selectedScales = { trades: null, liquidations: null, positions: null };

function renderScaleSelector(containerId, section) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <span class="scale-label">Scale</span>
        <div class="scale-buttons">
            ${Object.entries(SCALES).map(([key, scale]) => `
                <button class="scale-btn ${key === 'astley' ? 'astley' : ''} ${selectedScales[section] === key ? 'selected' : ''}" 
                        onclick="selectScale('${section}', '${key}')">${scale.name}</button>
            `).join('')}
        </div>
    `;
}

function selectScale(section, scaleKey) {
    selectedScales[section] = scaleKey;
    
    // Re-render the selector to show selection
    const selectorId = section === 'trades' ? 'tradeScaleSelector' : 
                       section === 'liquidations' ? 'liqScaleSelector' : 'positionsScaleSelector';
    renderScaleSelector(selectorId, section);
    
    // Apply scale to populate notes
    applyScaleToSection(section, scaleKey);
    
    // Show toast
    const scaleName = SCALES[scaleKey].name;
    showToast(`Applied ${scaleName} scale to ${section}`);
}

function getNoteFromInterval(rootNote, rootOctave, interval, direction) {
    // Convert root to semitone index
    const rootIdx = KEYS.indexOf(rootNote);
    if (rootIdx === -1) return { note: rootNote, octave: rootOctave };
    
    // Apply interval (ascending for buy, descending for sell)
    const semitones = direction === 'buy' ? interval : -interval;
    let newIdx = rootIdx + semitones;
    let newOctave = rootOctave;
    
    // Handle octave wrapping
    while (newIdx >= 12) { newIdx -= 12; newOctave++; }
    while (newIdx < 0) { newIdx += 12; newOctave--; }
    
    // Clamp octave
    newOctave = Math.max(3, Math.min(6, newOctave));
    
    return { note: KEYS[newIdx], octave: newOctave };
}

function generateScaleNotes(scaleKey, level, direction, rootNote = 'E', rootOctave = 5) {
    const scale = SCALES[scaleKey];
    
    if (scaleKey === 'astley') {
        // Astley uses pre-defined melodic pattern
        const pattern = ASTLEY_PATTERNS[direction];
        const noteCount = LEVEL_NOTE_COUNTS.astley[direction][level];
        return pattern.slice(0, noteCount).map(p => ({
            noteName: p.note,
            freq: NOTES[p.note],
            delay: p.delay,
            osc: 'triangle'
        }));
    }
    
    // Get note count and delays based on scale type
    const isPersian = scaleKey === 'persian';
    const noteCount = isPersian ? LEVEL_NOTE_COUNTS.persian[level] : LEVEL_NOTE_COUNTS.standard[level];
    const delays = isPersian ? PERSIAN_DELAYS[level] : LEVEL_DELAYS[level];
    const intervals = scale.intervals;
    const notes = [];
    
    // Pick intervals for this level
    // Standard: L0=1, L1=2, L2=3, L3=5 notes
    // Persian: L0=1, L1=3, L2=5, L3=7 notes (spread across scale)
    let intervalIndices;
    if (isPersian) {
        // Persian uses more exotic interval selection
        intervalIndices = level === 0 ? [0] :
                         level === 1 ? [0, 2, 4] :
                         level === 2 ? [0, 1, 2, 4, 5] :
                         [0, 1, 2, 3, 4, 5, 6]; // Full scale
    } else {
        intervalIndices = level === 0 ? [0] :
                         level === 1 ? [0, 2] :
                         level === 2 ? [0, 2, 4] :
                         [0, 2, 4, 5, intervals.length - 1];
    }
    
    for (let i = 0; i < noteCount && i < intervalIndices.length; i++) {
        const intervalIdx = Math.min(intervalIndices[i], intervals.length - 1);
        const interval = intervals[intervalIdx];
        const { note, octave } = getNoteFromInterval(rootNote, rootOctave, interval, direction);
        const noteName = note + octave;
        
        notes.push({
            noteName,
            freq: NOTES[noteName] || 440,
            delay: delays[i] || 0,
            osc: level >= 2 ? 'triangle' : 'sine'
        });
    }
    
    return notes;
}

function applyScaleToSection(section, scaleKey) {
    if (section === 'positions') {
        applyScaleToPositions(scaleKey);
    } else {
        applyScaleToScripts(section, scaleKey);
    }
}

function applyScaleToScripts(category, scaleKey) {
    const scriptKey = category === 'trades' ? 'thresholds' : 'liquidations';
    const rootNote = category === 'trades' ? 'E' : 'E';
    const rootOctave = 5;
    
    for (let level = 0; level < 4; level++) {
        // Generate buy notes (ascending)
        const buyNotes = generateScaleNotes(scaleKey, level, 'buy', rootNote, rootOctave);
        const buyScript = buyNotes.map(n => 
            `play(${n.freq.toFixed(2)}, 0.05 + gain / 10, 0.2 + ratio * 0.23, ${n.delay},,,'${n.osc}')`
        ).join('; ');
        
        // Generate sell notes (descending)
        const sellNotes = generateScaleNotes(scaleKey, level, 'sell', rootNote, rootOctave);
        const sellScript = sellNotes.map(n => 
            `play(${n.freq.toFixed(2)}, 0.05 + gain / 10, 0.2 + ratio * 0.23, ${n.delay},,,'${n.osc}')`
        ).join('; ');
        
        state.scripts[scriptKey][level] = { buy: buyScript, sell: sellScript };
    }
    
    // Re-render
    if (category === 'trades') renderTradeLanes();
    else renderLiqLanes();
}

function applyScaleToPositions(scaleKey) {
    const positionTypes = ['openLong', 'openShort', 'closeProfit', 'closeLoss'];
    
    // Astley uses pre-defined chords
    if (scaleKey === 'astley') {
        positionTypes.forEach(type => {
            state.positions[type] = ASTLEY_CHORDS[type].map(n => ({ ...n }));
        });
        renderChordBuilder();
        return;
    }
    
    const directions = ['buy', 'sell', 'buy', 'sell']; // Long/Profit=ascending, Short/Loss=descending
    const rootOctave = 5;
    const rootNote = 'E';
    
    positionTypes.forEach((type, typeIdx) => {
        const direction = directions[typeIdx];
        const isProfit = type === 'closeProfit';
        const isLoss = type === 'closeLoss';
        
        // Use level 3 for positions (5 notes)
        const notes = generateScaleNotes(scaleKey, 3, direction, rootNote, rootOctave);
        
        state.positions[type] = notes.slice(0, 5).map((n, i) => ({
            frequency: n.freq,
            gain: 0.16 - (i * 0.015),
            osc: i < 3 ? 'triangle' : 'sine',
            fadeIn: isProfit ? 0.012 : isLoss ? 0.018 : 0.015,
            holdDuration: isProfit ? 0.3 : isLoss ? 0.22 : 0.25,
            fadeOut: isProfit ? 0.55 : isLoss ? 0.5 : 0.45,
            delay: i * 0.008
        }));
    });
    
    renderChordBuilder();
}

// ============================================================
// INIT
// ============================================================
function renderAll() {
    renderScaleSelector('tradeScaleSelector', 'trades');
    renderScaleSelector('liqScaleSelector', 'liquidations');
    renderScaleSelector('positionsScaleSelector', 'positions');
    renderTradeLanes();
    renderLiqLanes();
    renderChordBuilder();
    renderFxRack();
    renderExport();
}

// Navigation
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(`panel-${item.dataset.panel}`).classList.add('active');
        if (item.dataset.panel === 'export') renderExport();
    });
});

document.getElementById('initAudioBtn').addEventListener('click', initAudio);

// Initialize
renderAll();
setupRatioSlider('tradeRatioTrack', 'tradeRatioValue', 'trade');
setupRatioSlider('liqRatioTrack', 'liqRatioValue', 'liq');
    </script>
</body>
</html>
